<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clinical Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="app-root">
    <div class="shell">
      <div class="layout">

        <!-- SIDEBAR -->
        <aside class="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-brand">
              <div class="brand-text">
                <div class="brand-title">EBM</div>
                <div class="sidebar-title">Clinical Engine</div>
              </div>
            </div>

            <input
              class="topic-search"
              type="text"
              placeholder="Search saved..."
            />
          </div>

          <div class="sidebar-subhead">Saved Items</div>
          <div class="conversation-list"></div>

          <div class="sidebar-footer">
            <span class="sidebar-hint">Locally stored â€¢ Per device</span>
          </div>
        </aside>

        <!-- MAIN -->
        <div class="main-region">
          <header class="header">
            <h1 class="title">CLINICAL ENGINE</h1>
            <p class="subtitle">Clinical questions + free-text consultation notes</p>
          </header>

          <!-- QUESTION + ANSWER -->
          <main class="grid">
            <section class="card input-card">
              <label class="label">Clinical Question</label>

              <textarea
                id="clinicalQuestion"
                class="textarea"
                rows="6"
                placeholder="Type a clinical questionâ€¦"
              ></textarea>

              <div class="actions actions-compact">
                <button id="generateBtn" class="btn btn-compact">Generate</button>
                <button class="btn btn-compact" disabled>ðŸŽ™ Dictate</button>
                <button id="clearQuestionBtn" class="btn btn-compact">Clear</button>
              </div>

              <div id="qStatus" class="mic-status">Ready</div>
            </section>

            <section class="card output-card">
              <div class="output-header">
                <h2 class="output-title">Answer</h2>
                <button id="copyAnswerBtn" class="copy-btn" disabled>Copy</button>
              </div>

              <div id="answerLoader" class="answer-loader hidden">
                Generatingâ€¦
              </div>

              <div class="output-body">
                <pre id="answer" class="answer"></pre>
              </div>
            </section>
          </main>

          <div class="divider-spacer"></div>

          <!-- CONSULTATION NOTES -->
          <section class="card wr-card">
            <div class="wr-head">
              <div>
                <div class="label">Consultation Notes</div>
                <div class="wr-sub">Dictation never triggers the Clinical Engine.</div>
              </div>

              <div class="actions actions-compact">
                <button class="btn btn-compact" disabled>ðŸŽ™ Dictate</button>
                <button id="copyWrBtn" class="btn btn-compact">Copy</button>
                <button id="saveWrBtn" class="btn btn-compact">Save</button>
                <button id="newWrBtn" class="btn btn-compact">New</button>
              </div>
            </div>

            <textarea
              id="wrNote"
              class="textarea"
              rows="14"
              placeholder="Type freely hereâ€¦"
            ></textarea>

            <div id="wrStatus" class="mic-status">Ready</div>
          </section>

        </div>
      </div>
    </div>
  </div>

<script>
window.addEventListener("DOMContentLoaded", () => {

  const clinicalQuestion = document.getElementById("clinicalQuestion");
  const generateBtn = document.getElementById("generateBtn");
  const clearQuestionBtn = document.getElementById("clearQuestionBtn");
  const answerEl = document.getElementById("answer");
  const answerLoader = document.getElementById("answerLoader");
  const copyAnswerBtn = document.getElementById("copyAnswerBtn");
  const qStatus = document.getElementById("qStatus");

  const wrNote = document.getElementById("wrNote");
  const copyWrBtn = document.getElementById("copyWrBtn");
  const saveWrBtn = document.getElementById("saveWrBtn");
  const newWrBtn = document.getElementById("newWrBtn");
  const wrStatus = document.getElementById("wrStatus");

  async function generate() {
    const query = clinicalQuestion.value.trim();
    if (!query) return;

    generateBtn.disabled = true;
    answerLoader.classList.remove("hidden");
    answerEl.textContent = "";
    copyAnswerBtn.disabled = true;
    qStatus.textContent = "Generatingâ€¦";

    try {
      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });

      const data = await res.json();
      answerEl.textContent = data.answer || data.error || "No response";
      copyAnswerBtn.disabled = !data.answer;
      qStatus.textContent = "Done";
    } catch {
      answerEl.textContent = "Error contacting server.";
      qStatus.textContent = "Error";
    } finally {
      answerLoader.classList.add("hidden");
      generateBtn.disabled = false;
    }
  }

  generateBtn.addEventListener("click", generate);

  clinicalQuestion.addEventListener("keydown", e => {
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
      e.preventDefault();
      generate();
    }
  });

  clearQuestionBtn.addEventListener("click", () => {
    clinicalQuestion.value = "";
    answerEl.textContent = "";
    qStatus.textContent = "Cleared";
  });

  copyAnswerBtn.addEventListener("click", async () => {
    await navigator.clipboard.writeText(answerEl.textContent);
  });

  copyWrBtn.addEventListener("click", async () => {
    await navigator.clipboard.writeText(wrNote.value);
    wrStatus.textContent = "Copied";
  });

  saveWrBtn.addEventListener("click", () => {
    localStorage.setItem("consultation_notes", wrNote.value);
    wrStatus.textContent = "Saved locally";
  });

  newWrBtn.addEventListener("click", () => {
    wrNote.value = "";
    wrStatus.textContent = "Cleared";
  });

});
</script>

</body>
</html>
