<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>VividMedi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>

/* ===============================
   GLOBAL POLISH
================================ */

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  letter-spacing: 0.2px;
}

.grid.equal-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.equal-grid .card {
  display: flex;
  flex-direction: column;
  height: 100%;
}

/* ===============================
   BUTTON SYSTEM (UNIFORM)
================================ */

.btn {
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 500;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color: #fff;
  transition: all 0.2s ease;
  min-width: 90px;
  text-align: center;
}

.btn:hover {
  background: rgba(255,255,255,0.12);
  transform: translateY(-1px);
}

.btn-primary {
  background: linear-gradient(135deg,#2563eb,#1e40af);
  border: none;
}

.btn-primary:hover {
  background: linear-gradient(135deg,#1d4ed8,#1e3a8a);
}

.btn-danger {
  background: rgba(220,38,38,0.15);
  border: 1px solid rgba(220,38,38,0.4);
}

.actions-compact .btn {
  height: 40px;
}

/* ===============================
   SMART DROPDOWN
================================ */

.dropdown {
  position: relative;
}

.dropdown-menu {
  position: absolute;
  top: 110%;
  left: 0;
  background: #111827;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px;
  min-width: 180px;
  padding: 6px;
  display: none;
  z-index: 100;
}

.dropdown-menu.open {
  display: block;
}

.dropdown-item {
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
}

.dropdown-item:hover {
  background: rgba(255,255,255,0.08);
}

/* ===============================
   DAY MODE TOGGLE
================================ */

.theme-toggle {
  margin-right: 16px;
}

.switch {
  position: relative;
  display: inline-block;
  width: 42px;
  height: 22px;
}

.switch input { display:none; }

.slider {
  position: absolute;
  cursor: pointer;
  background-color: #374151;
  border-radius: 34px;
  inset: 0;
  transition: 0.3s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 3px;
  bottom: 3px;
  background: white;
  border-radius: 50%;
  transition: 0.3s;
}

input:checked + .slider {
  background-color: #2563eb;
}

input:checked + .slider:before {
  transform: translateX(20px);
}

body.day-mode {
  filter: brightness(1.25);
}

/* ===============================
   CONSULT OUTPUT BOX
================================ */

.wr-output-wrapper {
  margin-top: 24px;
  border-top: 1px solid rgba(255,255,255,0.08);
  padding-top: 20px;
}

.answer {
  min-height: 160px;
}

</style>
</head>
<body>

<div class="app-root">
<div class="shell">
<div class="layout">

<!-- ===============================
     SIDEBAR
================================ -->

<aside class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-brand">
      <div class="vm-mark vm-mark--sm">
        <span class="vm-plus"></span>
      </div>
      <div class="brand-text">
        <div class="brand-title">VividMedi</div>
        <div class="sidebar-title">Clinical Intelligence Engine</div>
      </div>
    </div>

    <input id="sidebarSearch"
           class="topic-search"
           type="text"
           placeholder="Search saved..." />
  </div>

  <div class="sidebar-subhead">Clinical Content</div>
  <div id="savedQuestionsList" class="conversation-list"></div>

  <div class="sidebar-subhead">Referrals</div>
  <div id="savedWrList" class="conversation-list"></div>

  <div class="sidebar-subhead">Consultation Documentation</div>
  <div id="savedHandoverList" class="conversation-list"></div>

  <div class="sidebar-footer">
    <span class="sidebar-hint">Locally stored â€¢ Per device</span>
  </div>

</aside>

<!-- ===============================
     MAIN REGION
================================ -->

<div class="main-region">

<header class="header">

  <div class="theme-toggle">
    <label class="switch">
      <input type="checkbox" id="themeToggle">
      <span class="slider"></span>
    </label>
  </div>

  <div class="brand-header">
    <div class="vm-mark vm-mark--lg">
      <span class="vm-plus"></span>
    </div>
    <div class="brand-header__text">
      <h1 class="brand-header__name">VividMedi</h1>
      <div class="brand-header__tagline">
        Clinical Intelligence Engine
      </div>
    </div>
  </div>

  <div class="topbar-actions">
    <span id="usageChip" class="chip">Loading usageâ€¦</span>
    <button id="upgradeTopBtn" class="btn btn-primary" type="button">
      Upgrade to Pro
    </button>
    <button id="logoutBtn" class="btn" type="button" style="display:none;">
      Sign out
    </button>
    <div id="googleBtnTop" style="display:none;"></div>
  </div>

</header>

<!-- ===============================
     TOP GRID
================================ -->

<main class="grid equal-grid">

<!-- CLINICAL INPUT -->

<section class="card input-card">

<label class="label">Clinical</label>

<div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
  <label class="label label-tight" style="margin:0;">Mode</label>
  <select id="modeSelect" class="topic-search" style="max-width:260px;">
    <option value="clinical" selected>Clinical</option>
    <option value="dva_new">DVA D0904 (New referral)</option>
    <option value="dva_renew">DVA D0904 (Renewal)</option>
  </select>
</div>

<textarea id="clinicalQuestion"
          class="textarea"
          rows="7"></textarea>

<div class="actions actions-compact">
  <button id="generateBtn" class="btn btn-primary">Generate</button>
  <button id="dictateQuestionBtn" class="btn">ðŸŽ™ Dictate</button>
  <button id="incorrectQuestionBtn" class="btn">Incorrect</button>
  <button id="clearQuestionBtn" class="btn btn-danger">Clear</button>
</div>

<div id="qStatus" class="mic-status">
  Question mic: idle
</div>

</section>

<!-- ANSWER OUTPUT -->

<section class="card output-card">

<div class="output-header">
  <div class="output-header-flex">
    <h2 class="output-title-inline">Answers</h2>
    <button id="copyAllBtn"
            class="copy-btn main-copy-btn"
            disabled>
      Copy All
    </button>
  </div>
</div>

<div id="answerLoader" class="answer-loader hidden">
  <div class="loader"></div>
  <div class="loader-text">
    Generating structured answerâ€¦
  </div>
</div>

<div class="output-body">
  <div id="answer" class="answer placeholder">
    Your answer will appear here.
  </div>
</div>

</section>

</main>

<div class="divider-spacer"></div>

<!-- ===============================
     CONSULTATION SECTION
================================ -->

<section class="card wr-card">

<div class="wr-head">

  <div style="min-width:240px;">
    <div class="label wr-label">Consultation Notes</div>

    <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
      <label class="label label-tight" style="margin:0;">Mode</label>
      <select id="consultModeSelect"
              class="topic-search"
              style="max-width:260px;">
        <option value="consult_note" selected>Create Clinical Note</option>
        <option value="initial_consult">Initial Patient Consult</option>
        <option value="patient_review">Patient Review</option>
        <option value="discharge_summary">Discharge Summary</option>
        <option value="specialist_letter">Specialist Letter</option>
        <option value="handover">Handover Summary</option>
      </select>
    </div>
  </div>

  <div class="actions actions-compact">

    <div class="dropdown">
      <button id="smartDeviceBtn" class="btn">
        Connect Smart Device â–¾
      </button>
      <div id="smartDeviceMenu" class="dropdown-menu">
        <div class="dropdown-item">Smart Watch</div>
        <div class="dropdown-item">AI Glasses</div>
        <div class="dropdown-item">AI Necklace</div>
        <div class="dropdown-item">Smart Ring</div>
      </div>
    </div>

    <button id="generateWrBtn" class="btn btn-primary">
      Generate
    </button>

    <button id="dictateWrBtn" class="btn">
      ðŸŽ™ Dictate
    </button>

    <button id="incorrectWrBtn" class="btn">
      Incorrect
    </button>

    <button id="copyWrBtn" class="btn">
      Copy
    </button>

    <button id="clearWrBtn" class="btn btn-danger">
      Clear
    </button>

  </div>
</div>

<textarea id="wrNote"
          class="textarea"
          rows="16"></textarea>

<div id="wrStatus" class="mic-status">
  Notes mic: idle
</div>

<div class="wr-output-wrapper">

  <div class="output-header">
    <div class="output-header-flex">
      <h2 class="output-title-inline">
        Generated Consultation Output
      </h2>
      <button id="copyWrOutputBtn"
              class="copy-btn main-copy-btn"
              disabled>
        Copy
      </button>
    </div>
  </div>

  <div id="wrAnswerLoader"
       class="answer-loader hidden">
    <div class="loader"></div>
    <div class="loader-text">
      Generating consultation outputâ€¦
    </div>
  </div>

  <div class="output-body">
    <div id="wrOutput" class="answer placeholder">
      Generated consultation note will appear here.
    </div>
  </div>

</div>

</section>

</div>
</div>
</div>
</div>
<!-- ===============================
     PAYWALL MODAL
================================ -->

<div id="paywallBackdrop"
     class="vm-modal-backdrop"
     role="dialog"
     aria-modal="true"
     aria-labelledby="paywallTitle">

  <div class="vm-modal">

    <div class="vm-modal-head">
      <h3 id="paywallTitle" class="vm-modal-title">
        Free limit reached
      </h3>
      <button id="paywallClose"
              class="vm-modal-close"
              type="button">
        Ã—
      </button>
    </div>

    <div class="vm-modal-body">
      <p><strong id="paywallLine1">
        Youâ€™ve used 10/10 free generations.
      </strong></p>
      <p><strong id="paywallLine2">
        Upgrade to Pro for unlimited access.
      </strong></p>
      <p id="paywallLine3">
        Cancel anytime â€¢ Secure payments via Stripe
      </p>
    </div>

    <div class="vm-modal-foot">
      <button id="upgradeBtnModal"
              class="btn btn-primary"
              type="button">
        Upgrade to Pro
      </button>
      <span class="vm-spacer"></span>
    </div>

  </div>
</div>

<!-- ===============================
     MAIN SCRIPT
================================ -->

<script>
window.addEventListener("DOMContentLoaded", () => {

  /* ========= ELEMENTS ========= */

  const clinicalQuestion = document.getElementById("clinicalQuestion");
  const generateBtn = document.getElementById("generateBtn");
  const answerEl = document.getElementById("answer");
  const answerLoader = document.getElementById("answerLoader");
  const copyAllBtn = document.getElementById("copyAllBtn");

  const wrNote = document.getElementById("wrNote");
  const generateWrBtn = document.getElementById("generateWrBtn");
  const wrOutput = document.getElementById("wrOutput");
  const wrAnswerLoader = document.getElementById("wrAnswerLoader");
  const copyWrOutputBtn = document.getElementById("copyWrOutputBtn");

  const clearWrBtn = document.getElementById("clearWrBtn");
  const smartDeviceBtn = document.getElementById("smartDeviceBtn");
  const smartDeviceMenu = document.getElementById("smartDeviceMenu");
  const themeToggle = document.getElementById("themeToggle");

  const paywallBackdrop = document.getElementById("paywallBackdrop");
  const paywallClose = document.getElementById("paywallClose");
  const upgradeBtnModal = document.getElementById("upgradeBtnModal");

  /* ========= DAY MODE ========= */

  if (themeToggle) {
    themeToggle.addEventListener("change", () => {
      document.body.classList.toggle("day-mode");
    });
  }

  /* ========= SMART DROPDOWN ========= */

  if (smartDeviceBtn && smartDeviceMenu) {
    smartDeviceBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      smartDeviceMenu.classList.toggle("open");
    });

    document.addEventListener("click", (e) => {
      if (!smartDeviceBtn.contains(e.target) &&
          !smartDeviceMenu.contains(e.target)) {
        smartDeviceMenu.classList.remove("open");
      }
    });
  }

  /* ========= CLEAR CONSULT ========= */

  clearWrBtn.addEventListener("click", () => {
    wrNote.value = "";
    wrOutput.innerHTML =
      "Generated consultation note will appear here.";
    copyWrOutputBtn.disabled = true;
  });

  /* ========= COPY ========= */

  copyAllBtn.addEventListener("click", async () => {
    const text = (answerEl.innerText || "").trim();
    if (!text) return;
    await navigator.clipboard.writeText(text);
  });

  copyWrOutputBtn.addEventListener("click", async () => {
    const text = (wrOutput.innerText || "").trim();
    if (!text) return;
    await navigator.clipboard.writeText(text);
  });

  /* ========= STRUCTURED RENDER ========= */

  function buildStructuredHtml(text) {
    if (!text) return "";
    const sections = text.split("\n\n");
    return sections.map(s =>
      `<div class="answer-line">${s.trim()}</div>`
    ).join("");
  }

  /* ========= CLINICAL GENERATE ========= */

  generateBtn.addEventListener("click", async () => {

    const query = clinicalQuestion.value.trim();
    if (!query) return;

    generateBtn.disabled = true;
    answerLoader.classList.remove("hidden");
    answerEl.innerHTML = "";

    try {
      const res = await fetch("/api/generate", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ query })
      });

      if (res.status === 402) {
        paywallBackdrop.style.display = "flex";
        return;
      }

      const data = await res.json();
      answerEl.innerHTML = buildStructuredHtml(data.answer);
      copyAllBtn.disabled = false;

    } catch {
      answerEl.textContent = "Error generating answer.";
    } finally {
      answerLoader.classList.add("hidden");
      generateBtn.disabled = false;
    }

  });

  /* ========= CONSULT GENERATE ========= */

  generateWrBtn.addEventListener("click", async () => {

    const text = wrNote.value.trim();
    if (!text) return;

    generateWrBtn.disabled = true;
    wrAnswerLoader.classList.remove("hidden");
    wrOutput.innerHTML = "";

    try {
      const res = await fetch("/api/consult", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ text })
      });

      if (res.status === 402) {
        paywallBackdrop.style.display = "flex";
        return;
      }

      const data = await res.json();
      wrOutput.innerHTML =
        buildStructuredHtml(data.answer);

      copyWrOutputBtn.disabled = false;

    } catch {
      wrOutput.textContent =
        "Error generating consultation.";
    } finally {
      wrAnswerLoader.classList.add("hidden");
      generateWrBtn.disabled = false;
    }

  });

  /* ========= PAYWALL ========= */

  paywallClose.addEventListener("click", () => {
    paywallBackdrop.style.display = "none";
  });

  upgradeBtnModal.addEventListener("click", () => {
    window.location.href = "/pro";
  });

});
</script>

</body>
</html>
