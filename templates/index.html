<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EBM Clinical Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="app-root">
  <div class="shell">
    <div class="layout">

      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="brand-title">EBM SESSION</div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Saved Clinical Questions</div>
          <div id="savedQuestions"></div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Ward Round Templates</div>
          <div>WR Template (default)</div>
        </div>
      </aside>

      <!-- MAIN -->
      <div class="main-region">

        <!-- ================= CLINICAL ENGINE ================= -->
        <section class="card">
          <h2>Clinical Question</h2>

          <textarea id="clinicalQuestion" class="textarea" rows="4"
            placeholder="Dictate or type a clinical questionâ€¦"></textarea>

          <div class="actions">
            <button class="btn" id="dictateQuestion">ðŸŽ™ Dictate Question</button>
            <button class="btn" id="incorrectQuestion">Incorrect</button>
            <button class="btn" id="generateAnswer">Generate</button>
          </div>
        </section>

        <!-- ================= ANSWER ================= -->
        <section class="card">
          <h2>Answer</h2>
          <div id="answer" class="answer placeholder">
            Generated structured answer will appear here.
          </div>
        </section>

        <!-- ================= WARD ROUND ================= -->
        <section class="card">
          <h2>Ward Round Note</h2>

          <textarea id="wrNote" class="textarea" rows="20"></textarea>

          <div class="actions">
            <button class="btn" id="dictateWR">ðŸŽ™ Dictate WR</button>
            <button class="btn" id="incorrectWR">Incorrect</button>
            <button class="btn" onclick="copyWR()">Copy WR</button>
          </div>
        </section>

      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   DEFAULT WR TEMPLATE
   ========================= */
const WR_TEMPLATE = `WR:
Pt:

ISSUES:
1.
2.
3.
4.

==REVIEW==

==O/E==
Vitals:
Alertness & Orientation:
Fluid Balance:
Bowel chart:
Chest:
Abdo:
Cardiac:
Lower limbs:
Upper limbs:
Neuro:
Wounds:
Drains:

==Plan==
-
-
-`;

const wrNote = document.getElementById("wrNote");
if (!wrNote.value.trim()) wrNote.value = WR_TEMPLATE;

/* =========================
   LOCAL LEARNING MEMORY
   ========================= */
function getCorrections(key) {
  return JSON.parse(localStorage.getItem(key) || "{}");
}
function saveCorrection(key, wrong, correct) {
  const data = getCorrections(key);
  data[wrong.toLowerCase()] = correct;
  localStorage.setItem(key, JSON.stringify(data));
}
function applyCorrections(key, text) {
  const data = getCorrections(key);
  Object.keys(data).forEach(w => {
    const re = new RegExp(`\\b${w}\\b`, "gi");
    text = text.replace(re, data[w]);
  });
  return text;
}

/* =========================
   SPEECH SETUP
   ========================= */
function setupDictation(button, target, memoryKey) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return;

  const rec = new SR();
  rec.lang = "en-AU";
  rec.continuous = true;
  rec.interimResults = true;

  let active = false;

  rec.onresult = e => {
    let text = "";
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) text += e.results[i][0].transcript;
    }
    if (!text) return;

    text = applyCorrections(memoryKey, text.trim()) + ".\n";
    const start = target.selectionStart;
    target.value = target.value.slice(0, start) + text + target.value.slice(start);
    target.selectionStart = target.selectionEnd = start + text.length;
  };

  button.onclick = async () => {
    if (!active) {
      await navigator.mediaDevices.getUserMedia({ audio: true });
      rec.start();
      button.textContent = "â¹ Stop";
      active = true;
    } else {
      rec.stop();
      button.textContent = "ðŸŽ™ Dictate";
      active = false;
    }
  };
}

/* =========================
   INCORRECT BUTTON LOGIC
   ========================= */
function setupIncorrect(button, target, memoryKey) {
  button.onclick = () => {
    const sel = target.value.substring(
      target.selectionStart, target.selectionEnd
    );
    if (!sel) return alert("Highlight incorrect text first");
    const correction = prompt("Correct phrase:", sel);
    if (!correction) return;
    saveCorrection(memoryKey, sel, correction);
    alert("Saved. Will learn on this device.");
  };
}

/* =========================
   WIRE IT ALL UP
   ========================= */
setupDictation(
  document.getElementById("dictateQuestion"),
  document.getElementById("clinicalQuestion"),
  "q_corrections"
);
setupDictation(
  document.getElementById("dictateWR"),
  document.getElementById("wrNote"),
  "wr_corrections"
);

setupIncorrect(
  document.getElementById("incorrectQuestion"),
  document.getElementById("clinicalQuestion"),
  "q_corrections"
);
setupIncorrect(
  document.getElementById("incorrectWR"),
  document.getElementById("wrNote"),
  "wr_corrections"
);

/* =========================
   GENERATE ANSWER
   ========================= */
document.getElementById("generateAnswer").onclick = async () => {
  const q = document.getElementById("clinicalQuestion").value.trim();
  if (!q) return;

  const res = await fetch("/api/generate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query: q })
  });
  const data = await res.json();
  document.getElementById("answer").textContent =
    data.answer || data.error || "No response.";
};

function copyWR() {
  navigator.clipboard.writeText(wrNote.value);
  alert("WR copied");
}
</script>
</body>
</html>
