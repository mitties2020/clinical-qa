<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clinical Q&A Engine | EBM Sessions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="app-root">
    <div class="shell">
      <div class="layout">
        <!-- SIDEBAR -->
        <aside class="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-brand">
              <div class="brand-logo">EBM</div>
              <div class="brand-text">
                <div class="brand-title">EBM Sessions</div>
              </div>
            </div>
            <input id="topicSearch" class="topic-search" type="text" placeholder="Search topics..." />
          </div>

          <div id="conversationList" class="conversation-list"></div>

          <div class="sidebar-footer">
            <span class="sidebar-hint">Locally stored • Per device</span>
          </div>
        </aside>

        <!-- MAIN -->
        <div class="main-region">
          <header class="header">
            <h1 class="title">Clinical Q&amp;A Engine</h1>
            <p class="subtitle">Enter a clinical question to generate an evidence-based answer.</p>
          </header>

          <main class="grid">
            <!-- INPUT -->
            <section class="card input-card">
              <label class="label" for="question">Clinical Question</label>
              <textarea id="question" class="textarea" rows="6"
                placeholder="e.g. Evidence-based management of new-onset atrial fibrillation in a haemodynamically stable adult?"></textarea>
              <div class="actions">
                <button id="generateBtn" class="btn">Generate</button>
              </div>
            </section>

            <!-- OUTPUT -->
            <section class="card output-card">
              <div class="output-header">
                <h2 class="output-title">Answers</h2>
                <button id="copyAllBtn" class="copy-btn main-copy-btn" disabled>Copy All</button>
              </div>

              <div id="answerLoader" class="answer-loader hidden">
                <div class="loader"></div>
                <div class="loader-text">Generating structured answer…</div>
              </div>

              <div class="output-body">
                <div id="answer" class="answer placeholder">
                  Your structured, evidence-based response will appear here.
                </div>
              </div>
            </section>
          </main>
        </div>
      </div>
    </div>
  </div>

  <script>
    const questionInput = document.getElementById("question");
    const generateBtn = document.getElementById("generateBtn");
    const answerEl = document.getElementById("answer");
    const copyAllBtn = document.getElementById("copyAllBtn");
    const answerLoader = document.getElementById("answerLoader");
    const conversationListEl = document.getElementById("conversationList");
    const topicSearch = document.getElementById("topicSearch");

    /* ---------- HELPERS ---------- */
    function escapeHtml(str) {
      return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }
    function hasNonEmpty(arr){return Array.isArray(arr)&&arr.some(l=>l.trim()!=="");}
    function flashCopy(btn){
      const t=btn.textContent;btn.textContent="Copied";btn.classList.add("copied");
      setTimeout(()=>{btn.textContent=t;btn.classList.remove("copied");},900);
    }

    /* ---------- STRUCTURED HTML WITH GREEN BULLETS ---------- */
    function buildStructuredHtml(raw){
      if(!raw)return"";
      let text=raw.replace(/\*\*(.*?)\*\*/g,"$1").replace(/#{1,6}\s*/g,"").replace(/\r/g,"");
      const lines=text.split("\n");
      const order=["Summary","Overview","Assessment","Diagnosis","Investigations","Treatment","Management","Plan","Monitoring","Follow-up & Safety Netting","Follow-up","Red Flags","References"];
      const sections=[];let cur={title:"Summary",content:[]};let seen=false;
      const isHead=l=>{const t=l.trim().replace(/:$/,"");return order.find(h=>t.toLowerCase()===h.toLowerCase())||null;};
      for(const r of lines){const l=r.trim();if(!l){cur.content.push("");continue;}
        const h=isHead(l);if(h){if(hasNonEmpty(cur.content))sections.push(cur);cur={title:h,content:[]};seen=true;}
        else cur.content.push(l);}
      if(hasNonEmpty(cur.content))sections.push(cur);
      let html="";let i=0;
      if(!seen&&sections.length===1&&sections[0].title==="Summary"){
        const body=sections[0].content.join(" ").trim();if(!body)return"No response generated.";
        const id=`sec-${i++}`;
        return `<div class="section"><div class="section-header static"><span>Summary</span>
        <button class="section-copy-btn" data-target="${id}">Copy</button></div>
        <div class="section-body static-body" data-section="${id}"><p>${escapeHtml(body)}</p></div></div>`;
      }
      for(const s of sections){
        const t=s.title,b=s.content||[];if(!hasNonEmpty(b))continue;const id=`sec-${i++}`;
        const inner=b.filter(l=>l.trim()!=="").map(l=>{
          const ln=l.trim();
          if(/^[-•]\s+/.test(ln)||/^\d+[\.\)]\s+/.test(ln)){
            const c=ln.replace(/^[-•]\s+/,"").replace(/^\d+[\.\)]\s+/,"");
            return `<div class="answer-bullet"><span class="bullet-dot"></span><span class="bullet-text">${escapeHtml(c)}</span></div>`;
          }
          return `<p class="answer-paragraph">${escapeHtml(ln)}</p>`;
        }).join("");
        if(!inner.trim())continue;
        if(t==="Summary"||t==="Overview"){
          html+=`<div class="section"><div class="section-header static"><span>${escapeHtml(t)}</span>
          <button class="section-copy-btn" data-target="${id}">Copy</button></div>
          <div class="section-body static-body" data-section="${id}">${inner}</div></div>`;
        }else{
          html+=`<div class="section"><div class="collapsible-header">
          <button class="collapsible" data-target="${id}">${escapeHtml(t)}</button>
          <button class="section-copy-btn" data-target="${id}">Copy</button></div>
          <div class="collapsible-content" data-section="${id}">${inner}</div></div>`;
        }
      }
      return html||"No response generated.";
    }

    /* ---------- CONVERSATION STORAGE (with delete) ---------- */
    function loadConversations(){
      let d=[];try{d=JSON.parse(localStorage.getItem("ebm_conversations")||"[]");}catch{d=[];}
      conversationListEl.innerHTML="";
      if(!d.length){conversationListEl.innerHTML='<div class="conv-empty">No topics yet.</div>';return;}
      d.forEach((it,idx)=>{
        const item=document.createElement("div");item.className="conversation-item";
        item.innerHTML=`<div class="conv-main">
            <div class="conv-title">${escapeHtml(it.title||"Topic")}</div>
            <div class="conv-sub">${escapeHtml((it.query||"").slice(0,90))}</div>
          </div>
          <button class="conv-delete" data-index="${idx}" title="Delete">✕</button>`;
        item.querySelector(".conv-main").addEventListener("click",()=>{
          questionInput.value=it.query||"";answerEl.innerHTML=it.answer||"";
          const has=!!(it.answer&&it.answer.trim());
          answerEl.classList.toggle("placeholder",!has);copyAllBtn.disabled=!has;});
        item.querySelector(".conv-delete").addEventListener("click",e=>{
          e.stopPropagation();deleteConversation(idx);});
        conversationListEl.appendChild(item);
      });
    }

    function saveConversation(q,a){
      if(!q||!a)return;let d=[];try{d=JSON.parse(localStorage.getItem("ebm_conversations")||"[]");}catch{d=[];}
      const t=q.length>80?q.slice(0,80).trim()+"…":q.trim();
      d.push({title:t,query:q,answer:a});if(d.length>40)d=d.slice(d.length-40);
      localStorage.setItem("ebm_conversations",JSON.stringify(d));loadConversations();
    }
    function deleteConversation(i){
      let d=[];try{d=JSON.parse(localStorage.getItem("ebm_conversations")||"[]");}catch{d=[];}
      d.splice(i,1);localStorage.setItem("ebm_conversations",JSON.stringify(d));loadConversations();
    }
    function filterTopics(){
      const term=(topicSearch.value||"").toLowerCase().trim();
      const items=conversationListEl.querySelectorAll(".conversation-item");
      items.forEach(it=>{
        const t=(it.querySelector(".conv-title")?.textContent||"").toLowerCase();
        const s=(it.querySelector(".conv-sub")?.textContent||"").toLowerCase();
        it.style.display=!term||t.includes(term)||s.includes(term)?"":"none";
      });
    }

    /* ---------- GENERATE ANSWER ---------- */
    async function generate(){
      const q=questionInput.value.trim();if(!q)return;
      generateBtn.disabled=true;copyAllBtn.disabled=true;
      answerLoader.classList.remove("hidden");answerEl.classList.remove("placeholder");answerEl.innerHTML="";
      try{
        const r=await fetch("/api/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:q})});
        const data=await r.json();
        if(data.answer){
          const html=buildStructuredHtml(data.answer);
          answerEl.innerHTML=html;const has=!!answerEl.textContent.trim();
          copyAllBtn.disabled=!has;if(has)saveConversation(q,html);
        }else{answerEl.textContent=data.error||"No response generated.";copyAllBtn.disabled=true;}
      }catch(e){console.error(e);answerEl.textContent="Error generating answer.";copyAllBtn.disabled=true;}
      finally{answerLoader.classList.add("hidden");generateBtn.disabled=false;}
    }

    /* ---------- EVENTS ---------- */
    generateBtn.addEventListener("click",generate);
    questionInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();generate();}});
    copyAllBtn.addEventListener("click",async()=>{
      const t=answerEl.textContent.trim();if(!t)return;
      await navigator.clipboard.writeText(t);flashCopy(copyAllBtn);
    });
    document.addEventListener("click",async e=>{
      if(e.target.classList.contains("section-copy-btn")){
        const id=e.target.dataset.target;
        const sec=document.querySelector(`[data-section="${id}"]`);
        if(!sec)return;await navigator.clipboard.writeText(sec.innerText.trim());flashCopy(e.target);
      }else if(e.target.classList.contains("collapsible")){
        const id=e.target.dataset.target;
        const c=document.querySelector(`.collapsible-content[data-section="${id}"]`);
        if(!c)return;const open=c.style.display==="block";
        e.target.classList.toggle("active",!open);c.style.display=open?"none":"block";
      }
    });
    topicSearch.addEventListener("input",filterTopics);
    window.addEventListener("DOMContentLoaded",loadConversations);
  </script>
</body>
</html>
