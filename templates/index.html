<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clinical Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="app-root">
    <div class="shell">
      <div class="layout">

        <aside class="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-brand">
              <div class="brand-logo"></div>
              <div class="brand-text">
                <div class="brand-title">EBM</div>
                <div class="sidebar-title">Clinical Engine</div>
              </div>
            </div>
            <input id="sidebarSearch" class="topic-search" type="text" placeholder="Search saved..." />
          </div>

          <div class="sidebar-subhead">Saved Clinical Questions</div>
          <div id="savedQuestionsList" class="conversation-list"></div>

          <div class="sidebar-subhead">Consultation Notes (saved)</div>
          <div id="savedWrList" class="conversation-list"></div>

          <div class="sidebar-footer">
            <span class="sidebar-hint">Locally stored â€¢ Per device</span>
          </div>
        </aside>

        <div class="main-region">
          <header class="header">
            <h1 class="title">CLINICAL ENGINE</h1>
            <p class="subtitle">Clinical questions (top) + consultation notes (below). Dictation never triggers the Clinical Engine.</p>
          </header>

          <main class="grid">
            <section class="card input-card">
              <label class="label">Clinical Question</label>

              <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                <label class="label" style="margin:0;">Mode</label>
                <select id="modeSelect" class="topic-search" style="max-width:220px;">
                  <option value="clinical" selected>Clinical</option>
                  <option value="dva">DVA Referral Check</option>
                </select>
              </div>

              <textarea id="clinicalQuestion" class="textarea" rows="7"
                placeholder="Enter clinical question OR paste DVA patient details. Enter = Generate, Shift+Enter = new line."></textarea>

              <div class="actions actions-compact">
                <button id="generateBtn" class="btn btn-compact">Generate</button>
                <button id="dictateQuestionBtn" class="btn btn-compact">ðŸŽ™ Dictate</button>
                <button id="incorrectQuestionBtn" class="btn btn-compact">Incorrect</button>
                <button id="clearQuestionBtn" class="btn btn-compact">Clear</button>
              </div>

              <div id="qStatus" class="mic-status">Ready.</div>
            </section>

            <section class="card output-card">
              <div class="output-header">
                <h2 class="output-title">Answers</h2>
                <button id="copyAllBtn" class="copy-btn main-copy-btn" disabled>Copy All</button>
              </div>

              <div class="output-body">
                <div id="answer" class="answer placeholder">Your answer will appear here.</div>
              </div>
            </section>
          </main>

        </div>
      </div>
    </div>
  </div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  const answerEl = document.getElementById("answer");
  const copyAllBtn = document.getElementById("copyAllBtn");

  function escapeHtml(str) {
    return (str || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function buildStructuredHtml(raw) {
    const sections = raw.split(/\n(?=[A-Z][A-Za-z &]+:)/);
    let html = "";
    let idx = 0;

    sections.forEach(block => {
      const [title, ...rest] = block.split(":");
      const body = rest.join(":").trim();
      const id = "sec-" + idx++;

      html += `
        <div class="section">
          <div class="collapsible-header">
            <button class="collapsible" data-target="${id}">${escapeHtml(title)}</button>
            <button class="section-copy-btn copy-btn" data-target="${id}">Copy</button>
          </div>
          <div class="collapsible-content" data-section="${id}" style="display:none;">
            <p>${escapeHtml(body)}</p>
          </div>
        </div>`;
    });

    return html;
  }

  document.addEventListener("click", async (e) => {
    const t = e.target;

    if (t.classList.contains("collapsible")) {
      const id = t.dataset.target;
      const content = document.querySelector(`[data-section="${id}"]`);
      const open = content.style.display === "block";
      content.style.display = open ? "none" : "block";
    }

    if (t.classList.contains("section-copy-btn")) {
      const id = t.dataset.target;
      const section = document.querySelector(`[data-section="${id}"]`);
      navigator.clipboard.writeText(section.innerText);
    }
  });

});
</script>
</body>
</html>
