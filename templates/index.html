<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clinical Engine | EBM Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="app-root">
  <div class="shell">
    <div class="layout">

      <!-- ================= SIDEBAR ================= -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-brand">
            <div class="brand-logo"></div>
            <div class="brand-text">
              <div class="brand-title">EBM</div>
              <div class="sidebar-title">EBM Session</div>
            </div>
          </div>
          <input id="sidebarSearch" class="topic-search" type="text" placeholder="Search savedâ€¦" />
        </div>

        <div style="padding:8px 6px; font-size:12px; opacity:.75;">Clinical Questions</div>
        <div id="savedQuestionsList" class="conversation-list"></div>

        <div style="padding:12px 6px 6px; font-size:12px; opacity:.75;">Ward Round Notes</div>
        <div id="savedWrList" class="conversation-list"></div>

        <div class="sidebar-footer">Locally stored â€¢ Per device</div>
      </aside>

      <!-- ================= MAIN ================= -->
      <div class="main-region">
        <header class="header">
          <h1 class="title">CLINICAL ENGINE</h1>
          <p class="subtitle">Clinical questions (top) â€¢ Ward round dictation (below)</p>
        </header>

        <!-- ================= CLINICAL ENGINE ================= -->
        <main class="grid">
          <section class="card input-card">
            <label class="label">Clinical Question</label>
            <textarea id="clinicalQuestion" class="textarea" rows="6"
              placeholder="Type or dictate a clinical questionâ€¦"></textarea>

            <div class="actions" style="gap:8px;">
              <button id="generateBtn" class="btn" type="button">Generate</button>
              <button id="dictateQuestionBtn" class="btn" type="button">ðŸŽ™ Dictate</button>
              <button id="incorrectQuestionBtn" class="btn" type="button">Incorrect</button>
              <button id="clearQuestionBtn" class="btn" type="button">Clear</button>
            </div>

            <div id="qStatus" style="font-size:12px; opacity:.75;">Question mic: idle</div>
          </section>

          <section class="card output-card">
            <div class="output-header">
              <h2 class="output-title">Answer</h2>
              <button id="copyAllBtn" class="copy-btn" disabled>Copy All</button>
            </div>

            <div id="answerLoader" class="answer-loader hidden">
              <div class="loader"></div>
              <div class="loader-text">Generatingâ€¦</div>
            </div>

            <div class="output-body">
              <div id="answer" class="answer placeholder">
                Your structured answer will appear here.
              </div>
            </div>
          </section>
        </main>

        <!-- ================= WARD ROUND ================= -->
        <section class="card" style="margin-top:14px;">
          <label class="label">Ward Round Notes</label>

          <div class="actions" style="gap:8px;">
            <button id="dictateWrBtn" class="btn">ðŸŽ™ Dictate</button>
            <button id="incorrectWrBtn" class="btn">Incorrect</button>
            <button id="saveWrBtn" class="btn">Save</button>
            <button id="newWrBtn" class="btn">New</button>
          </div>

          <textarea id="wrNote" class="textarea" rows="16"></textarea>
          <div id="wrStatus" style="font-size:12px; opacity:.75;">WR mic: idle</div>
        </section>

      </div>
    </div>
  </div>
</div>

<script>
/* ===================== WR TEMPLATE ===================== */
const WR_TEMPLATE = `WR:

Pt:

ISSUES:
1.
2.
3.
4.

==REVIEW==

==O/E==
Vitals:
Alertness & Orientation:
Fluid Balance:
Bowel chart:
Chest:
Abdo:
Cardiac:
Lower limbs:
Upper limbs:
Neuro:
Wounds:
Drains:

==Plan==
-
-
-`;

const STORE_Q = "ebm_saved_q_v1";
const STORE_WR = "ebm_saved_wr_v1";
const STORE_Q_CORR = "ebm_q_corr_v1";
const STORE_WR_CORR = "ebm_wr_corr_v1";

/* ===================== ELEMENTS ===================== */
const clinicalQuestion = document.getElementById("clinicalQuestion");
const wrNote = document.getElementById("wrNote");
const answerEl = document.getElementById("answer");
const answerLoader = document.getElementById("answerLoader");
const copyAllBtn = document.getElementById("copyAllBtn");
const qStatus = document.getElementById("qStatus");
const wrStatus = document.getElementById("wrStatus");

/* ===================== INIT ===================== */
if (!wrNote.value) wrNote.value = WR_TEMPLATE;

/* ===================== STORAGE ===================== */
const load = k => JSON.parse(localStorage.getItem(k)||"[]");
const save = (k,v) => localStorage.setItem(k,JSON.stringify(v));

/* ===================== SIDEBAR ===================== */
function renderSidebar() {
  const qList = load(STORE_Q);
  const wList = load(STORE_WR);

  const qEl = document.getElementById("savedQuestionsList");
  const wEl = document.getElementById("savedWrList");

  qEl.innerHTML = qList.map(q =>
    `<div class="conversation-item"><div class="conv-title"
      onclick="document.getElementById('clinicalQuestion').value=${JSON.stringify(q)}">${q}</div></div>`
  ).join("") || '<div class="conv-empty">None</div>';

  wEl.innerHTML = wList.map(w =>
    `<div class="conversation-item"><div class="conv-title"
      onclick="document.getElementById('wrNote').value=${JSON.stringify(w)}">${w.slice(0,40)}â€¦</div></div>`
  ).join("") || '<div class="conv-empty">None</div>';
}
renderSidebar();

/* ===================== GENERATE ===================== */
async function generate() {
  const q = clinicalQuestion.value.trim();
  if (!q) return;

  answerLoader.classList.remove("hidden");
  answerEl.innerHTML = "";

  const res = await fetch("/api/generate", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ query:q })
  });
  const data = await res.json();

  answerLoader.classList.add("hidden");

  if (data.answer) {
    answerEl.innerText = data.answer;
    copyAllBtn.disabled = false;
    save(STORE_Q, [q, ...load(STORE_Q)].slice(0,50));
    renderSidebar();
  } else {
    answerEl.innerText = data.error || "Error.";
  }
}

document.getElementById("generateBtn").onclick = generate;
document.getElementById("clearQuestionBtn").onclick = () => clinicalQuestion.value = "";
copyAllBtn.onclick = () => navigator.clipboard.writeText(answerEl.innerText);

/* ===================== DICTATION ===================== */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
function makeRec(statusEl, cb) {
  const r = new SR();
  r.lang = "en-AU";
  r.continuous = true;
  r.interimResults = false;
  r.onresult = e => cb(e.results[e.results.length-1][0].transcript);
  r.onstart = () => statusEl.textContent = "Mic: listeningâ€¦";
  r.onend = () => statusEl.textContent = "Mic: stopped.";
  return r;
}

/* Question dictation */
let qRec;
document.getElementById("dictateQuestionBtn").onclick = () => {
  if (!qRec) qRec = makeRec(qStatus, t => {
    clinicalQuestion.value = t;
    generate();
  });
  qRec.start();
};

/* WR dictation */
let wRec;
document.getElementById("dictateWrBtn").onclick = () => {
  if (!wRec) wRec = makeRec(wrStatus, t => {
    wrNote.value += "\n" + t;
  });
  wRec.start();
};

/* ===================== WR ACTIONS ===================== */
document.getElementById("saveWrBtn").onclick = () => {
  save(STORE_WR, [wrNote.value, ...load(STORE_WR)].slice(0,50));
  renderSidebar();
};
document.getElementById("newWrBtn").onclick = () => wrNote.value = WR_TEMPLATE;
</script>

</body>
</html>
