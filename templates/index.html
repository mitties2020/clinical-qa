{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  <div class="row">
    <div class="col-lg-8 mx-auto">

      <h1 class="mb-3">Clinical Q&amp;A Engine</h1>
      <p class="text-muted small">
        This tool is for education only. It provides general, evidence-informed information with Australian spelling
        and does <strong>not</strong> give individual treatment or dosing advice. Always follow local guidelines and
        discuss with a senior clinician.
      </p>

      <!-- Question form -->
      <form id="question-form" class="mt-4">
        <div class="mb-3">
          <label for="question" class="form-label">Clinical question</label>
          <textarea
            id="question"
            name="question"
            class="form-control"
            rows="5"
            placeholder="e.g. Risk stratification for chest pain with normal ECG and troponin, or approach to new-onset AF in the ED."
            required
          ></textarea>
        </div>

        <button type="submit" id="submit-btn" class="btn btn-primary">
          Ask question
        </button>
        <span id="loading-indicator" class="text-muted small ms-2" style="display:none;">
          Thinkingâ€¦
        </span>
      </form>

      <!-- Error message -->
      <div id="error-box" class="alert alert-danger mt-3 py-2 small" style="display:none;"></div>

      <!-- Answer output -->
      <div id="answer-wrapper" class="mt-4" style="display:none;">
        <h4>Response</h4>
        <div id="answer" class="card">
          <div class="card-body" id="answer-body">
            <!-- Filled by JS -->
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("question-form");
  const questionInput = document.getElementById("question");
  const submitBtn = document.getElementById("submit-btn");
  const loadingIndicator = document.getElementById("loading-indicator");
  const errorBox = document.getElementById("error-box");
  const answerWrapper = document.getElementById("answer-wrapper");
  const answerBody = document.getElementById("answer-body");

  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    const question = questionInput.value.trim();
    if (!question) {
      errorBox.textContent = "Please enter a question.";
      errorBox.style.display = "block";
      return;
    }

    // UI: clear old stuff, show loading
    errorBox.style.display = "none";
    answerWrapper.style.display = "none";
    loadingIndicator.style.display = "inline";
    submitBtn.disabled = true;

    try {
      const resp = await fetch("/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ question: question })
      });

      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        const msg = data.error || "There was a problem contacting the backend.";
        throw new Error(msg);
      }

      const data = await resp.json();
      const answer = data.answer || "(No answer returned.)";

      // Show answer
      answerBody.innerText = answer;
      answerWrapper.style.display = "block";

    } catch (err) {
      console.error(err);
      errorBox.textContent = err.message || "Unexpected error occurred.";
      errorBox.style.display = "block";
    } finally {
      loadingIndicator.style.display = "none";
      submitBtn.disabled = false;
    }
  });
});
</script>
{% endblock %}
