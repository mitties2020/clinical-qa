<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clinical Engine | EBM Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="app-root">
    <div class="shell">
      <div class="layout">
        <aside class="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-brand">
              <div class="brand-logo"></div>
              <div class="brand-text">
                <div class="brand-title">EBM</div>
                <div class="sidebar-title">EBM Session</div>
              </div>
            </div>
            <input id="topicSearch" class="topic-search" type="text" placeholder="Search topics..." />
          </div>
          <div id="conversationList" class="conversation-list"></div>
          <div class="sidebar-footer">
            <span class="sidebar-hint">Locally stored • Per device</span>
          </div>
        </aside>

        <div class="main-region">
          <header class="header">
            <h1 class="title">CLINICAL ENGINE</h1>
            <p class="subtitle">Enter a clinical question to generate an evidence-based answer.</p>
          </header>

          <main class="grid">
            <section class="card input-card">
              <label class="label" for="question">Clinical Question</label>
              <textarea id="question" class="textarea" rows="6"></textarea>
              <div class="actions">
                <button id="generateBtn" class="btn">Generate</button>
              </div>
            </section>

            <section class="card output-card">
              <div class="output-header">
                <h2 class="output-title">Answers</h2>
                <button id="copyAllBtn" class="copy-btn main-copy-btn" disabled>Copy All</button>
              </div>

              <div id="answerLoader" class="answer-loader hidden">
                <div class="loader"></div>
                <div class="loader-text">Generating structured answer…</div>
              </div>

              <div class="output-body">
                <div id="answer" class="answer placeholder">Your structured response will appear here.</div>
              </div>
            </section>
          </main>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------- BASIC GENERATE ----------------
    const questionInput = document.getElementById("question");
    const generateBtn = document.getElementById("generateBtn");
    const answerEl = document.getElementById("answer");
    const answerLoader = document.getElementById("answerLoader");

    async function generate() {
      const query = questionInput.value.trim();
      if (!query) return;

      answerLoader.classList.remove("hidden");
      answerEl.classList.remove("placeholder");
      answerEl.textContent = "";

      try {
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query })
        });
        const data = await res.json();
        answerEl.textContent = data.answer || data.error || "No response.";
      } catch (e) {
        console.error(e);
        answerEl.textContent = "Error generating answer.";
      } finally {
        answerLoader.classList.add("hidden");
      }
    }

    generateBtn.addEventListener("click", generate);

    questionInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        generate();
      }
    });

    // =========================================================
    // VOICE ACTIVATION (WAKE WORD) USING /api/transcribe (Whisper)
    // - Tap once anywhere to enable mic (browser requirement)
    // - Then say: "Hi EBM ...your question..."
    // - Auto-fills #question and clicks Generate
    // =========================================================
    (function () {
      const WAKE = ["hi ebm", "hey ebm", "okay ebm"];
      const CHUNK_MS = 4000;     // paid Render: fewer calls, good accuracy
      const COOLDOWN_MS = 6000;
      const SESSION_KEY = "ebm_voice_wake_enabled_v1";

      let stream = null;
      let recorder = null;
      let chunks = [];
      let running = false;
      let lastFire = 0;
      let rollingText = "";
      let mimeTypeChosen = "";

      function norm(s) {
        return (s || "").toLowerCase().replace(/\s+/g, " ").trim();
      }

      function pickMimeType() {
        const candidates = [
          "audio/webm;codecs=opus",
          "audio/webm",
          "audio/ogg;codecs=opus",
          "audio/ogg"
        ];
        for (const t of candidates) {
          if (window.MediaRecorder?.isTypeSupported?.(t)) return t;
        }
        return "";
      }

      function findWakeAndExtract(text) {
        const lower = norm(text);
        for (const w of WAKE) {
          if (lower.includes(w)) {
            const re = new RegExp(w, "i");
            const after = text.replace(re, "").trim().replace(/^[,:\-\s]+/, "");
            return after || "";
          }
        }
        return null;
      }

      async function transcribeBlob(blob) {
        const form = new FormData();
        form.append("audio", blob, "chunk.webm");

        const res = await fetch("/api/transcribe", { method: "POST", body: form });
        const raw = await res.text();

        let data = {};
        try { data = JSON.parse(raw); } catch {}

        if (!res.ok) {
          console.warn("EBM Voice: /api/transcribe failed", res.status, data.error || raw);
          return "";
        }
        return (data.text || "").trim();
      }

      async function startVoiceLoop() {
        if (running) return;
        running = true;

        stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        mimeTypeChosen = pickMimeType();
        recorder = mimeTypeChosen
          ? new MediaRecorder(stream, { mimeType: mimeTypeChosen })
          : new MediaRecorder(stream);

        recorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };

        recorder.start();
        console.log("EBM Voice: armed. Say 'Hi EBM ...'");

        const interval = setInterval(async () => {
          if (!running) { clearInterval(interval); return; }

          try { recorder.stop(); } catch { return; }

          setTimeout(async () => {
            if (!running) return;

            const blob = new Blob(chunks, { type: recorder.mimeType || "audio/webm" });
            chunks = [];

            // Restart recorder immediately
            try {
              recorder = mimeTypeChosen
                ? new MediaRecorder(stream, { mimeType: mimeTypeChosen })
                : new MediaRecorder(stream);

              recorder.ondataavailable = (e) => {
                if (e.data && e.data.size > 0) chunks.push(e.data);
              };
              recorder.start();
            } catch (e) {
              console.warn("EBM Voice: recorder restart failed", e);
              return;
            }

            // Skip tiny blobs (silence)
            if (!blob || blob.size < 1500) return;

            const text = await transcribeBlob(blob);
            if (!text) return;

            rollingText = (rollingText + " " + text).trim();
            if (rollingText.length > 350) rollingText = rollingText.slice(-350);

            const now = Date.now();
            if (now - lastFire < COOLDOWN_MS) return;

            const extracted = findWakeAndExtract(rollingText);
            if (extracted !== null) {
              // Wake phrase heard but question not yet
              if (!extracted) return;

              lastFire = now;
              questionInput.value = extracted;
              rollingText = "";

              setTimeout(() => generateBtn.click(), 150);
            }
          }, 50);
        }, CHUNK_MS);
      }

      async function enableOnce() {
        if (sessionStorage.getItem(SESSION_KEY) === "1") return;

        const ok = confirm(
          "Enable voice activation for this tab?\n\n" +
          "Then say: 'Hi EBM ...your question...'"
        );
        if (!ok) return;

        sessionStorage.setItem(SESSION_KEY, "1");

        try {
          await startVoiceLoop();
        } catch (e) {
          console.warn("EBM Voice: failed to start", e);
          alert("Could not start microphone. Check Chrome mic permissions for this site.");
        }
      }

      // Browser requirement: start mic on first user interaction
      document.addEventListener("click", function firstTap() {
        document.removeEventListener("click", firstTap, true);
        enableOnce();
      }, true);

      // If already enabled in this tab session, try to start again on load
      window.addEventListener("DOMContentLoaded", async () => {
        if (sessionStorage.getItem(SESSION_KEY) === "1") {
          try { await startVoiceLoop(); } catch {}
        }
      });
    })();
  </script>
</body>
</html>
