<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clinical Engine | EBM Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="app-root">
<div class="shell">
<div class="layout">

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-brand">
      <div class="brand-logo"></div>
      <div class="brand-text">
        <div class="brand-title">EBM</div>
        <div class="sidebar-title">EBM Session</div>
      </div>
    </div>
    <input id="sidebarSearch" class="topic-search" placeholder="Search savedâ€¦" />
  </div>

  <div style="padding:8px 12px; font-size:12px;">Saved Clinical Questions</div>
  <div id="savedQuestionsList" class="conversation-list"></div>

  <div style="padding:8px 12px; font-size:12px;">Ward Round Notes</div>
  <div id="savedWrList" class="conversation-list"></div>

  <div class="sidebar-footer">Locally stored â€¢ Per device</div>
</aside>

<!-- ================= MAIN ================= -->
<div class="main-region">

<header class="header">
  <h1 class="title">CLINICAL ENGINE</h1>
  <p class="subtitle">Clinical questions above â€¢ Ward round dictation below</p>
</header>

<!-- ================= CLINICAL ENGINE ================= -->
<main class="grid">

<section class="card">
  <label class="label">Clinical Question</label>
  <textarea id="clinicalQuestion" class="textarea" rows="6"></textarea>

  <div class="actions" style="gap:10px;">
    <button id="generateBtn" class="btn">Generate</button>
    <button id="dictateQBtn" class="btn">ðŸŽ™ Dictate</button>
    <button id="incorrectQBtn" class="btn">Incorrect</button>
    <button id="clearQBtn" class="btn">Clear</button>
  </div>

  <div id="qStatus" style="font-size:12px; opacity:.7;">Mic: idle</div>
</section>

<section class="card output-card">
  <div class="output-header">
    <h2 class="output-title">Answer</h2>
    <button id="copyAllBtn" class="copy-btn" disabled>Copy All</button>
  </div>

  <div id="answerLoader" class="answer-loader hidden">
    <div class="loader"></div>
    <div class="loader-text">Generatingâ€¦</div>
  </div>

  <div class="output-body">
    <div id="answer" class="answer placeholder">
      Structured answer will appear here.
    </div>
  </div>
</section>

</main>

<!-- ================= WARD ROUND ================= -->
<section class="card" style="margin-top:16px;">
  <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
    <div class="label">Ward Round Notes</div>
    <div class="actions" style="gap:10px;">
      <button id="dictateWrBtn" class="btn">ðŸŽ™ Dictate</button>
      <button id="incorrectWrBtn" class="btn">Incorrect</button>
      <button id="saveWrBtn" class="btn">Save</button>
      <button id="newWrBtn" class="btn">New</button>
      <button id="copyWrBtn" class="btn">Copy</button>
    </div>
  </div>

  <textarea id="wrNote" class="textarea" rows="16"></textarea>
  <div id="wrStatus" style="font-size:12px; opacity:.7;">Mic: idle</div>
</section>

</div>
</div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ================= WR TEMPLATE ================= */
const WR_TEMPLATE = `WR:

Pt:

ISSUES:
1.
2.
3.
4.

==REVIEW==

==O/E==
Vitals:
Alertness & Orientation:
Fluid Balance:
Bowel chart:
Chest:
Abdo:
Cardiac:
Lower limbs:
Upper limbs:
Neuro:
Wounds:
Drains:

==Plan==
-
-
-`;

/* ================= ELEMENTS ================= */
const clinicalQuestion = document.getElementById("clinicalQuestion");
const wrNote = document.getElementById("wrNote");
const answerEl = document.getElementById("answer");
const answerLoader = document.getElementById("answerLoader");
const copyAllBtn = document.getElementById("copyAllBtn");

const qStatus = document.getElementById("qStatus");
const wrStatus = document.getElementById("wrStatus");

if (!wrNote.value.trim()) wrNote.value = WR_TEMPLATE;

/* ================= SPEECH ENGINE (FIXED) ================= */
function makeRecognizer({ statusEl, onCommit }) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SR();
  rec.lang = "en-AU";
  rec.interimResults = true;
  rec.continuous = true;

  let bufferFinal = "";
  let bufferInterim = "";
  let armed = false;

  function commit(reason) {
    const text = (bufferFinal + " " + bufferInterim).trim();
    bufferFinal = "";
    bufferInterim = "";
    if (text) onCommit(text);
    statusEl.textContent = reason || "Mic: committed";
  }

  rec.onresult = (e) => {
    let interim="", final="";
    for (let i=e.resultIndex;i<e.results.length;i++){
      const t=e.results[i][0].transcript;
      if (e.results[i].isFinal) final+=t+" ";
      else interim+=t+" ";
    }
    if (final) bufferFinal+=final;
    if (interim) bufferInterim=interim;
    statusEl.textContent="Mic: hearingâ€¦";
  };

  rec.onend = () => { if (armed) rec.start(); };

  return {
    start(){ armed=true; rec.start(); statusEl.textContent="Mic: listeningâ€¦"; },
    stop(){ armed=false; commit("Mic: committed"); try{rec.stop();}catch{} }
  };
}

/* ================= QUESTION DICTATION ================= */
let qRec=null, qOn=false;
document.getElementById("dictateQBtn").onclick=()=>{
  if(!qRec){
    qRec=makeRecognizer({
      statusEl:qStatus,
      onCommit:(t)=>{clinicalQuestion.value=t; document.getElementById("generateBtn").click();}
    });
  }
  qOn=!qOn;
  qOn?qRec.start():qRec.stop();
};

/* ================= WR DICTATION ================= */
let wrRec=null, wrOn=false;
document.getElementById("dictateWrBtn").onclick=()=>{
  if(!wrRec){
    wrRec=makeRecognizer({
      statusEl:wrStatus,
      onCommit:(t)=>{
        wrNote.value+="\n"+t;
      }
    });
  }
  wrOn=!wrOn;
  wrOn?wrRec.start():wrRec.stop();
};

/* ================= GENERATE ================= */
document.getElementById("generateBtn").onclick=async()=>{
  const q=clinicalQuestion.value.trim();
  if(!q) return;
  answerLoader.classList.remove("hidden");
  answerEl.innerHTML="";
  const r=await fetch("/api/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:q})});
  const d=await r.json();
  answerLoader.classList.add("hidden");
  answerEl.innerText=d.answer||d.error;
  copyAllBtn.disabled=!d.answer;
};

/* ================= BUTTONS ================= */
document.getElementById("clearQBtn").onclick=()=>clinicalQuestion.value="";
document.getElementById("copyWrBtn").onclick=()=>navigator.clipboard.writeText(wrNote.value);
document.getElementById("copyAllBtn").onclick=()=>navigator.clipboard.writeText(answerEl.innerText);
document.getElementById("newWrBtn").onclick=()=>wrNote.value=WR_TEMPLATE;
</script>

</body>
</html>
